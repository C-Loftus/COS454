---
title: "COS454_FinalProject_TestScript"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(rlang)
library(dplyr)
library("data.table")
library(ggplot2)
# we can use relative paths instead of absolute paths
setwd("./")
```

```{r}
# sample_data = read.csv("data/2/experiment_report-day-1667774775005.csv")
# sample_data = read.csv("data/1/experiment_report-day-1667677166294.csv")

sample_data <- read.csv("data/1/experiment_report-night-1667701658903.csv")

relevant_data <- sample_data %>% select(state_1_choice, transition, outcome)

relevant_data <- relevant_data %>% slice(5:n())
```

```{r}
# Note: transition == 0 refers to the rare transition
# Note: transition == 1 refers to the common transition

relevant_data_table <- data.table(relevant_data)
relevant_data_table <- relevant_data_table[, next_state_choice := state_1_choice]

shifted_data <- relevant_data_table[, state_1_choice := shift(state_1_choice)]
shifted_data <- relevant_data_table[, transition := shift(transition)]
shifted_data <- relevant_data_table[, outcome := shift(outcome)]

shifted_df <- data.frame(shifted_data[2:nrow(shifted_data) - 2, ])
shifted_df <- shifted_df %>% mutate(stay = state_1_choice == next_state_choice)
```
    
```{r} 

count_df <- shifted_df %>%
    group_by(stay, transition, outcome) %>%
    summarise(count = n(), .groups = "drop")
count_df
#############################################

prob_df <- count_df %>%
    group_by(transition, outcome) %>%
    mutate(total = sum(count)) %>%
    ungroup() %>%
    group_by(transition, outcome) %>%
    mutate(prob = count / total) %>%
    ungroup()
prob_df
```

```{r}
sumDecisionType <- function(df, stay, outcome, commonTransition) {
    return(sum(df$stay == stay & df$outcome == outcome & df$transition == commonTransition, na.rm = TRUE))
}
```


```{r}
# Common Transition, Rewarded, Stay
ct_r_s <- sumDecisionType(shifted_df, stay = TRUE, outcome = 1, commonTransition = 1)

# Common Transition, Rewarded, Leave
ct_r_l <- sumDecisionType(shifted_df, stay = FALSE, outcome = 1, commonTransition = 1)

# Rare Transition, Rewarded, Stay
rt_r_s <- sumDecisionType(shifted_df, stay = TRUE, outcome = 1, commonTransition = 0)

# Rare Transition, Rewarded, Leave
rt_r_l <- sumDecisionType(shifted_df, stay = FALSE, outcome = 1, commonTransition = 0)

# Common Transition, Unrewarded, Stay
ct_ur_s <- sumDecisionType(shifted_df, stay = TRUE, outcome = 0, commonTransition = 1)

# Common Transition, Unrewarded, Leave
ct_ur_l <- sumDecisionType(shifted_df, stay = FALSE, outcome = 0, commonTransition = 1)

# Rare Transition, Unrewarded, Stay
rt_ur_s <- sumDecisionType(shifted_df, stay = TRUE, outcome = 0, commonTransition = 0)

# Rare Transition, Unrewarded, Leave
rt_ur_l <- sumDecisionType(shifted_df, stay = FALSE, outcome = 0, commonTransition = 0)
```

```{r}
b1 <- ct_r_s / (ct_r_s + ct_r_l)
b2 <- rt_r_s / (rt_r_s + rt_r_l)

b3 <- ct_ur_s / (ct_ur_s + ct_ur_l)
b4 <- rt_ur_s / (rt_ur_s + rt_ur_l)
```

```{r}
reward_type <- c(rep("rewarded", 2), rep("unrewarded", 2))
transition <- rep(c("common", "rare"), 2)
value <- c(b1, b2, b3, b4)
data <- data.frame(reward_type, transition, value)

ggplot(data, aes(fill = transition, y = value, x = reward_type)) +
    geom_bar(position = "dodge", stat = "identity")
```

```{r}
# create logistic regression model

# drops all NA rows that would be an issue for the model
finaldf <- shifted_df[complete.cases(shifted_df), ]
finaldf

mod <- glm(stay ~ outcome * transition, data = finaldf, family = binomial)
mod %>% summary()
```

# Paired T-Test for Morning vs Evening Trials
Read in all the csvs and split them into morning and evening trials

```{r}
tirednessMapping <- jsonlite::fromJSON("data/sleepiness.json")$meta

allCsvs <- list.files("data", pattern = "*.csv", full.names = TRUE, recursive = TRUE)
allCsvs
allNight <- all_csvs[grep("night", all_csvs)] %>%
    lapply(read.csv)
allDay <- all_csvs[grep("day", all_csvs)] %>% lapply(read.csv)

all_people <- list.files("data", pattern="", full.names = TRUE, recursive = FALSE)  
all_people <- all_people[!grepl("json", all_people)]

```

```{r}
library(lme4)
# Use linear mixed effects model to combine all subjects into one regression


# -> see if thereâ€™s effect of tiredness on model-based versus model-free weights at the group level
```

<!-- Notes: code common transitions as 1, rare as -1 in order to get favorable logistic regression properties. (Do same for reward) -->
<!-- Notes: center tiredness as another interaction term with -1 , 1 -->